#
# CDDL HEADER START
#
# The contents of this file are subject to the terms of the
# Common Development and Distribution License (the "License").
# You may not use this file except in compliance with the License.
#
# See LICENSE.txt included in this distribution for the specific
# language governing permissions and limitations under the License.
#
# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at LICENSE.txt.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]
#
# CDDL HEADER END
#

#
# Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
# Use is subject to license terms.
#

createTableRepositories=\
  CREATE TABLE REPOSITORIES (\
    ID INT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, \
    PATH VARCHAR(32672) UNIQUE NOT NULL)

createTableFiles=\
  CREATE TABLE FILES (\
    ID INT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, \
    PATH VARCHAR(32672) NOT NULL, \
    REPOSITORY INT NOT NULL REFERENCES REPOSITORIES ON DELETE CASCADE, \
    UNIQUE (REPOSITORY, PATH))

createTableAuthors=\
  CREATE TABLE AUTHORS (\
    ID INT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, \
    REPOSITORY INT NOT NULL REFERENCES REPOSITORIES ON DELETE CASCADE, \
    NAME VARCHAR(32672) NOT NULL, \
    UNIQUE (REPOSITORY, NAME))

createTableChangesets=\
  CREATE TABLE CHANGESETS (\
    ID INT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, \
    REPOSITORY INT NOT NULL REFERENCES REPOSITORIES ON DELETE CASCADE, \
    REVISION VARCHAR(1024) NOT NULL, \
    AUTHOR INT NOT NULL REFERENCES AUTHORS ON DELETE CASCADE, \
    TIME TIMESTAMP NOT NULL, \
    MESSAGE VARCHAR(32672) NOT NULL, \
    UNIQUE (REPOSITORY, REVISION))

createIndexChangesetsIdDesc=\
  CREATE UNIQUE INDEX IDX_CHANGESETS_ID_DESC ON CHANGESETS(ID DESC)

createTableFilechanges=\
  CREATE TABLE FILECHANGES (\
    ID INT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, \
    FILE INT NOT NULL REFERENCES FILES ON DELETE CASCADE, \
    CHANGESET INT NOT NULL REFERENCES CHANGESETS ON DELETE CASCADE, \
    UNIQUE (FILE, CHANGESET))

hasCacheForDirectory=\
  SELECT 1 FROM REPOSITORIES R \
  WHERE R.PATH = ? AND EXISTS \
      (SELECT 1 FROM FILES F \
         WHERE F.REPOSITORY = R.ID AND F.PATH LIKE ? ESCAPE '#')

getFileHistory=\
  SELECT CS.REVISION, A.NAME, CS.TIME, CS.MESSAGE, F2.PATH \
  FROM \
      CHANGESETS CS, FILECHANGES FC, REPOSITORIES R, FILES F, AUTHORS A, \
      FILECHANGES FC2, FILES F2 \
  WHERE \
      R.PATH = ? AND F.PATH = ? AND F.REPOSITORY = R.ID AND \
      A.REPOSITORY = R.ID AND CS.ID = FC.CHANGESET AND R.ID = CS.REPOSITORY \
      AND FC.FILE = F.ID AND A.ID = CS.AUTHOR AND \
      CS.ID = FC2.CHANGESET AND FC2.FILE = F2.ID \
  ORDER BY CS.ID DESC

getDirHistory=\
  SELECT CS.REVISION, A.NAME, CS.TIME, CS.MESSAGE, F.PATH \
  FROM \
      CHANGESETS CS, FILECHANGES FC, REPOSITORIES R, FILES F, AUTHORS A \
  WHERE \
      R.PATH = ? AND F.REPOSITORY = R.ID AND A.REPOSITORY = R.ID AND \
      CS.REPOSITORY = R.ID AND CS.ID = FC.CHANGESET AND F.ID = FC.FILE AND \
      A.ID = CS.AUTHOR AND \
      EXISTS (\
          SELECT 1 \
          FROM FILES F2 \
          WHERE \
              F2.ID = FC.FILE AND F2.REPOSITORY = R.ID AND \
              F2.PATH LIKE ? ESCAPE '#') \
  ORDER BY CS.ID DESC

getRepository=SELECT ID FROM REPOSITORIES WHERE PATH = ?

addRepository=INSERT INTO REPOSITORIES(PATH) VALUES ?

addChangeset=\
  INSERT INTO CHANGESETS (REPOSITORY, REVISION, AUTHOR, TIME, MESSAGE) \
  VALUES (?,?,?,?,?)

addFilechange=INSERT INTO FILECHANGES(CHANGESET, FILE) VALUES (?,?)

getAuthors=SELECT NAME, ID FROM AUTHORS WHERE REPOSITORY = ?

addAuthor=INSERT INTO AUTHORS (REPOSITORY, NAME) VALUES (?,?)

getFiles=SELECT PATH, ID FROM FILES WHERE REPOSITORY = ?

addFile=INSERT INTO FILES(REPOSITORY, PATH) VALUES (?,?)

getLatestCachedRevision=\
  SELECT REVISION FROM CHANGESETS WHERE ID = \
    (SELECT MAX(CS.ID) FROM CHANGESETS CS, REPOSITORIES R \
            WHERE CS.REPOSITORY = R.ID AND R.PATH = ?)
