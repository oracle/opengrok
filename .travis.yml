language: java
cache:
  directories:
  - "$HOME/.m2"
  - "$HOME/.sonar/cache"
addons:
  sonarcloud:
    organization: opengrok
    token:
      secure: ayjmifQPQgKt/ICGfKtLpa8LwBAXZlxKwaPyjvXDRHyf3lbXGKkOCspH/wSoersoV4ZLt5UfSGKeFh1MS0IXAwUOcPTcV3/DUmycJjxZ5z9KjgGKsu0Spo1xZWioS+p1bzN6cJcNlwihE97idLhVSvDProf6L+pn0dqw8Lfz2k0=
jobs:
  include:
  - stage: test
    name: Linux + OpenJDK 11
    os: linux
    dist: xenial
    sudo: required
    jdk: openjdk11
    install: true
    script: dev/main
    before_install: dev/before_install
    before_script: dev/before
  - stage: test
    name: macOS + Oracle JDK 11
    os: osx
    osx_image: xcode10.1
    jdk: oraclejdk11
    install: true
    script: dev/main
    before_install: dev/before_install
    before_script: dev/before
  - stage: test
    name: Windows + Open JDK 11
    # Use shell until Travis supports Java on Windows proper.
    language: shell
    os: windows
    install: true
    script: dev/main
    before_install: dev/before_install.windows openjdk11
    before_script: dev/before
  - stage: deploy
    name: Github Release
    dist: xenial
    jdk: openjdk11
    if: repo = "oracle/opengrok" AND tag IS present
    before_install: dev/before_install
    install: true
    script: dev/pre-deploy.sh
    deploy:
    - provider: releases
      name: "$TRAVIS_TAG"
      api_key:
        secure: bCywC9GdBIzLvLG3cgM9SgOAdMRQchmqEyKQZtIfK4iNzH3GjZwLMH91Oha0X3XU/n+nxGKw2E9qpYRzWlcbxHXqIgjFTt+hkt7zAldjjyWJnOcAYqdUDfsH3NqNQBqMBg8q7Bjc0LVS6PfpTpZliZISrL6KSyDprRg7C0S+HAk=
      file: distribution/target/opengrok-$TRAVIS_TAG.tar.gz
      skip_cleanup: true
      on:
        condition: "$TRAVIS_TAG =~ ^[0-9\\.]+$"
        all_branches: true
  - stage: docker
    name: Docker image build
    dist: xenial
    jdk: openjdk11
    install: true
    services:
    - docker
    before_install: dev/before_install
    script: dev/docker.sh
  - stage: javadoc
    name: Upload javadocs to Github pages
    os: linux
    dist: xenial
    jdk: openjdk11
    script: dev/javadoc.sh
    install: true
    if: repo = "oracle/opengrok" AND tag IS NOT present
